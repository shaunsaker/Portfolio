var map = [[{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5}],[{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":2},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":3},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5}],[{"value":5},{"value":6},{"value":0},{"value":6},{"value":6},{"value":6},{"value":6},{"value":1},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":1},{"value":2},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":1},{"value":6},{"value":2},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5}],[{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":1},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":4},{"value":6},{"value":6},{"value":5}],[{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":1},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":5},{"value":5},{"value":6},{"value":5},{"value":5},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":1},{"value":6},{"value":3},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5}],[{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5}],[{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":5},{"value":5},{"value":5},{"value":6},{"value":5},{"value":6},{"value":1},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5}],[{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5}],[{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":2},{"value":6},{"value":6},{"value":1},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":3},{"value":5}],[{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":2},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5}],[{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":1},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5}],[{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5}],[{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5}],[{"value":5},{"value":6},{"value":6},{"value":6},{"value":1},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":1},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5}],[{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5}],[{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":1},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5}],[{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":5},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":5},{"value":6},{"value":5},{"value":5},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5}],[{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5}],[{"value":5},{"value":5},{"value":5},{"value":5},{"value":6},{"value":5},{"value":5},{"value":5},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5}],[{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5}],[{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":1},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5}],[{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":1},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5}],[{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":2},{"value":6},{"value":6},{"value":6},{"value":6},{"value":1},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":3},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5}],[{"value":5},{"value":6},{"value":6},{"value":3},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":6},{"value":5}],[{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5},{"value":5}]];

// TODO
  // Assign darkness
  // Handle user movement
  // Assign health, xp, level, weapon
  // Handle enemy, health, weapon, boss, wall

var Cell = React.createClass({
  getClasses: function() {
    var classes = "";
      switch (this.props.value) {
        case 0:
          classes = "player";
          break;
        case 1:
          classes = "enemy";
          break;
        case 2:
          classes = "health";
          break;
        case 3:
          classes = "weapon";
          break;
        case 4:
          classes = "boss";
          break;
        case 5:
          classes = "wall";
          break;
        default:
          classes = "empty";
      }
      if (this.props.darkness && this.props.darkness === 1) {
        classes += " dark";
      }
      return classes;
  },
  render: function() {
    return (
      <div className={"cell " + this.getClasses()} x={this.props.x} y={this.props.y}></div>
    )
  }
});

var Canvas = React.createClass({
  map: map,
  width: 50,
  height: 25,
  cursor: 0,
  health: 100,
  newHealth: 50,
  weapon: 'Fists',
  damage: 25,
  playerChance: 2.5,
  enemyHealth: 50,
  enemyDamage: 25,
  enemyChance: 2,
  bossHealth: 100,
  xp: 0,
  level: 1,
  weapons: [
    {weapon: 'Baseball Bat', damage: 33}, 
    {weapon: 'Katana', damage: 50}, 
    {weapon: 'Desert Eagle', damage: 66}, 
    {weapon: 'AK47', damage: 75}, 
    {weapon: 'Rocket Launcher', damage: 100}
  ],
  lightCells: [ //[y, x]
    [1, -3],
    [0, -3],
    [-1, -3],
    [2, -2],
    [1, -2],
    [0, -2],
    [-1, -2],
    [-2, -2],
    [-2, 2],
    [-1, 2],
    [0, 2],
    [1, 2],
    [2, 2],
    [1, 3],
    [0, 3],
    [-1, 3],
    [-2, -2],
    [-2, -1],
    [-2, 0],
    [-2, 1],
    [-2, 2],
    [2, -1],
    [2, 0],
    [2, 1],
    [3, -1],
    [3, 0],
    [4, 0],
    [-4, 0],
    [0, 4],
    [0, -4],
    [3, 1],
    [-3, -1],
    [-3, 0],
    [-3, 1],
    [-1, -1],
    [-1, 0],
    [-1, 1],
    [0, -1],
    [0, 0],
    [0, 1],
    [1, -1],
    [1, 0],
    [1, 1]
  ],
  playerPos: [], //[y, x]
  getInitialState: function() {
    return {
      cells:JSON.parse(localStorage.getItem('cells')) || map,
      gameStatus: {
        text: "You're busy playing",
        button: "Restart game"
      }
    }
  },
  createSquares: function(row, rowIndex) {
    return (
      row.map(function(val, colIndex){
        return (
          <Cell x={rowIndex} y={colIndex} value={val.value} darkness={val.darkness}/>
        )
      })
    )
  },
  getPlayerPosition: function() {
    var current = this;
    current.state.cells.map(function(row, rowIndex) {
      row.map(function(val, colIndex) {
        if (val.value === 0) {
          current.playerPos[0] = rowIndex;
          current.playerPos[1] = colIndex;
        }
      })
    })
  },
  assignValues: function(newState) {
    var current = newState || this;
    var player = current.playerPos;

    // Assign health
    current.state.cells[player[0]][player[1]]['health'] = current.health;

    // Assign weapon
    current.state.cells[player[0]][player[1]]['weapon'] = current.weapon;

    // Assign xp
    current.state.cells[player[0]][player[1]]['xp'] = current.xp;

    // Assign level
    current.state.cells[player[0]][player[1]]['level'] = current.level;

    // Assign light/darkness
    var light = current.lightCells;
    var newLight = [];
    light.map(function(val, index) {
      // Update light cells according to playerPos
      var newCoords = [];
      var lightY = player[0] + val[0];
      newCoords.push(lightY);
      var lightX = player[1] + val[1];
      newCoords.push(lightX);
      newLight.push(newCoords);
    });
    
    current.state.cells.map(function(row, rowIndex) {
      row.map(function(cell, colIndex) {
        // Assign weapons to weapon cells
        if (current.weapons.length && cell.value === 3) {
          var newWeapon = current.weapons.pop();
          cell.weapon = newWeapon.weapon;
          cell['damage'] = newWeapon.damage;
        }

        // Assign health to enemies
        if (cell.value === 1 && !cell.health) {
          cell['health'] = current.enemyHealth;
        }

        // Assign health to boss
        if (cell.value === 4 && !cell.health) {
          cell['health'] = current.bossHealth;
        }

        for (var i = 0; i < newLight.length; i++) {
          if (rowIndex === newLight[i][0] && colIndex === newLight[i][1]) {
            cell['darkness'] = 0;
            break;
          }
          else {
            cell['darkness'] = 1;
          }
        }
      })
    })
    this.setState(current.state);
  },
  battle: function(nextCell, player) {
    var playerDamage = Math.round(Math.random() * this.damage * this.playerChance);
    nextCell.health -= playerDamage;
    if (nextCell.value === 4) {
      var enemyDamage = Math.round(Math.random() * this.damage * this.enemyChance);
    }
    else {
      var enemyDamage = Math.round(Math.random() * this.enemyDamage * this.enemyChance);
    }
    player.health -= enemyDamage;

    if (player.health <= 0) {
      var status = 'lost';
    }

    else if (nextCell.health <= 0) {
      var status = 'won';
      this.xp += this.enemyHealth;

      if (this.xp >= 100) {
        this.level += 1;
        this.enemyHealth += 50;
        this.bossHealth += 100;
        this.xp = this.xp - 100;
      }
    }

    else if (nextCell.health > 0) {
      var status = 'battling';
    }

    return {
      nextCell: nextCell,
      player: player,
      status: status
    }
  },
  handleMovement: function(e) {
    // Handles objects
      // If enemy or boss, fight

    var current = this;

    var x = current.playerPos[1];
    var y = current.playerPos[0];

    var player = current.state.cells[y][x];

    if (e.which === 37 || e.which === 38 || e.which === 39 || e.which === 40) {
      e.preventDefault();
    }

    if (e.which === 38) {
      var newY = y - 1;
      var nextCell = current.state.cells[newY][x];
      if (newY > -1 && nextCell.value !== 5) {
        if (nextCell.value === 2) {
          current.health += current.newHealth;
        }
        if (nextCell.value === 3) {
          current.weapon = nextCell.weapon;
          current.damage = nextCell.damage;
        }
        var status = true;
        if (nextCell.value === 1 || nextCell.value === 4) {
          var battle = current.battle(nextCell, player);
          if (battle.status === 'lost') {
            this.game(battle.status);
          }
          else if (battle.status === 'battling') {
            player = battle.player;
            current.health = player.health;
            var enemy = battle.nextCell;
            current.state.cells[y].splice(x, 1, player);
            current.state.cells[newY].splice(x, 1, enemy);
            this.assignValues(current);
          }
          else if (battle.status === 'won' && nextCell.value === 1) {
            player = battle.player;
            current.health = player.health;
            current.state.cells[y].splice(x, 1, {value: 6});
            current.state.cells[newY].splice(x, 1, player);
            this.playerPos = [newY, x];
            this.assignValues(current);
          }
          else if (battle.status === 'won' && nextCell.value === 4) {
            this.game(battle.status);
          }
        }
        else {
          current.state.cells[y].splice(x, 1, {value: 6});
          current.state.cells[newY].splice(x, 1, player);
          this.playerPos = [newY, x];
          this.assignValues(current);
        }
      }
    }
    else if (e.which === 40) {
      var newY = y + 1;
      var nextCell = current.state.cells[newY][x];
      if (newY < current.state.cells.length && nextCell.value !== 5) {
        if (nextCell.value === 2) {
          current.health += current.newHealth;
        }
        if (nextCell.value === 3) {
          current.weapon = nextCell.weapon;
          current.damage = nextCell.damage;
        }
        var status = true;
        if (nextCell.value === 1 || nextCell.value === 4) {
          var battle = current.battle(nextCell, player);
          if (battle.status === 'lost') {
            this.game(battle.status);
          }
          else if (battle.status === 'battling') {
            player = battle.player;
            current.health = player.health;
            var enemy = battle.nextCell;
            current.state.cells[y].splice(x, 1, player);
            current.state.cells[newY].splice(x, 1, enemy);
            this.assignValues(current);
          }
          else if (battle.status === 'won' && nextCell.value === 1) {
            player = battle.player;
            current.health = player.health;
            current.state.cells[y].splice(x, 1, {value: 6});
            current.state.cells[newY].splice(x, 1, player);
            this.playerPos = [newY, x];
            this.assignValues(current);
          }
          else if (battle.status === 'won' && nextCell.value === 4) {
            this.game(battle.status);
          }
        }
        else {
          current.state.cells[y].splice(x, 1, {value: 6});
          current.state.cells[newY].splice(x, 1, player);
          this.playerPos = [newY, x];
          this.assignValues(current);
        }
      }
    }
    else if (e.which === 37) {
      var newX = x - 1;
      var nextCell = current.state.cells[y][newX];
      if (newX > -1 && nextCell.value !== 5) {
        if (nextCell.value === 2) {
          current.health += current.newHealth;
        }
        if (nextCell.value === 3) {
          current.weapon = nextCell.weapon;
          current.damage = nextCell.damage;
        }
        var status = true;
        if (nextCell.value === 1 || nextCell.value === 4) {
          var battle = current.battle(nextCell, player);
          if (battle.status === 'lost') {
            this.game(battle.status);
          }
          else if (battle.status === 'battling') {
            player = battle.player;
            current.health = player.health;
            var enemy = battle.nextCell;
            current.state.cells[y].splice(x, 1, player);
            current.state.cells[y].splice(newX, 1, enemy);
            this.assignValues(current);
          }
          else if (battle.status === 'won' && nextCell.value === 1) {
            player = battle.player;
            current.health = player.health;
            current.state.cells[y].splice(x, 1, {value: 6});
            current.state.cells[y].splice(newX, 1, player);
            this.playerPos = [y, newX];
            this.assignValues(current);
          }
          else if (battle.status === 'won' && nextCell.value === 4) {
            this.game(battle.status);
          }
        }
        else {
          current.state.cells[y].splice(x, 1, {value: 6});
          current.state.cells[y].splice(newX, 1, player);
          this.playerPos = [y, newX];
          this.assignValues(current);
        }
      }
    }
    else if (e.which === 39) {
      var newX = x + 1;
      var nextCell = current.state.cells[y][newX];
      if (newX < current.state.cells[y].length && nextCell.value !== 5) {
        if (nextCell.value === 2) {
          current.health += current.newHealth;
        }
        if (nextCell.value === 3) {
          current.weapon = nextCell.weapon;
          current.damage = nextCell.damage;
        }
        var status = true;
        if (nextCell.value === 1 || nextCell.value === 4) {
          var battle = current.battle(nextCell, player);
          if (battle.status === 'lost') {
            this.game(battle.status);
          }
          else if (battle.status === 'battling') {
            player = battle.player;
            current.health = player.health;
            var enemy = battle.nextCell;
            current.state.cells[y].splice(x, 1, player);
            current.state.cells[y].splice(newX, 1, enemy);
            this.assignValues(current);
          }
          else if (battle.status === 'won' && nextCell.value === 1) {
            player = battle.player;
            current.health = player.health;
            current.state.cells[y].splice(x, 1, {value: 6});
            current.state.cells[y].splice(newX, 1, player);
            this.playerPos = [y, newX];
            this.assignValues(current);
          }
          else if (battle.status === 'won' && nextCell.value === 4) {
            this.game(battle.status);
          }
        }
        else {
          current.state.cells[y].splice(x, 1, {value: 6});
          current.state.cells[y].splice(newX, 1, player);
          this.playerPos = [y, newX];
          this.assignValues(current);
        }
      }
    }
  },
  game: function(status) {
    this.setState({gameStatus: {text: 'You ' + status, button: 'Restart Game'}});
    window.removeEventListener("keydown", this.handleMovement, false);
    $("#modal").modal('show');
  },
  onUserExit: function() {
    $('#modal').modal('hide');
  },
  restart: function() {
    window.location.reload();
  },
  newGame: function() {
    this.setState({cells: JSON.parse(localStorage.getItem('cells')) || map});
  },
  componentWillMount: function() {
    this.getPlayerPosition();
    this.assignValues();
  },
  componentDidMount: function() {
    window.addEventListener("keydown", this.handleMovement, false);
    var width = this.width * 15 + "px";
    $('.canvas').css( "width", width);
  },
  render: function() {
    return (
      <div className="container">
        <div className="intro text-center">
          <h1>FCC Roguelike Dungeon Crawler Game</h1>
          <p>Kill your enemies, gain XP, level up, pickup health, upgrade your weapon and kill the boss to win!</p>
          <ul>
            <li><div className="legend player"></div><p>Player</p></li>
            <li><div className="legend enemy"></div><p>Enemy</p></li>
            <li><div className="legend health"></div><p>Health</p></li>
            <li><div className="legend weapon"></div><p>Weapon</p></li>
            <li><div className="legend boss"></div><p>Boss</p></li>
            <li><div className="legend wall"></div><p>Wall</p></li>
            <li><div className="legend empty"></div><p>Empty</p></li>
          </ul>
          <ul className="stats">
            <li><p>Health:</p><p>{this.health}</p></li>
            <li><p>Weapon:</p><p>{this.weapon}</p></li>
            <li><p>Damage:</p><p>{this.damage}</p></li>
            <li><p>Level:</p><p>{this.level}</p></li>
            <li><p>XP:</p><p>{this.xp}</p></li>
          </ul>
        </div>
        <div className="canvas">
          {this.state.cells.map(this.createSquares)}
        </div>
        <div id="modal" className="modal fade" role="dialog">
          <div className="modal-dialog">
            <div className="modal-content">
              <div className="modal-body">
                <h1>{this.state.gameStatus.text}</h1>
                <button type="button" className="btn btn-default" onClick={this.restart}>{this.state.gameStatus.button}</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    )
  }
});

ReactDOM.render(<Canvas />, document.getElementById('app'));